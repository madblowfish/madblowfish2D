function RADTODEGREE(a){return 180*a/Math.PI}function DEGREETORAD(a){return a*Math.PI/180}function Layer(){this.renderables=new Array,this.opacity=1,this.hasTransformations=!0,this.transformation=new Transformation,this.visible=!0}function PreloadImages(){this.assets=new Array,this.funcUpdate=void 0,this.funcComplete=void 0,this.funcCompleteObj=void 0,this.funcCompleteName=void 0,this.counter=0,this.counterLoaded=0}function Renderable(){this.transformation=new Transformation,this.shape=RenderableShape.Circle,this.visible=!0,this.mouseover=!1,this.OnCamera=!0,this.opacity=void 0,this.isClickable=!1,this.width=this.height=0,this.updateFunc=void 0,this.updateFuncObj=void 0,this.updateFuncName=void 0}function Scene(){this.camera={transformation:new Transformation},this.isTranslated=!1,this.isScaled=!1,this.opacity=1,this.opacityState=1,this.sceneOpacityChanged=!1,this.layers=new Array(new Layer),this.mouse=new Vector2D,this.usingMouse=!0,this.element=void 0,this.isCulling=!0,this.sceneType=void 0,this.initTime=(new Date).getTime(),this.currentTime=0}function SceneCanvas(a){Scene.call(this),this.element="string"==typeof a?document.getElementById(a):a,this.context=this.element.getContext("2d"),this.CreateEventListeners()}function Sprite(){Renderable.call(this),this.textures=[],this.textureInUse=0,this.clippingX=0,this.clippingY=0,this.clippingWidth=0,this.clippingHeight=0,this.isClipping=!1}function SpriteAnimated(a){Sprite.call(this),this.isPlaying=this.isLooping=this.isPaused=!1,this.repeat=1,this.timerPauseLength=this.timeStart=0,this._frame=0,this._internalRepeat=1,this.yoyo=!1,this.frameSpeed=a,this.startFunc=void 0,this.startFuncObj=void 0,this.startFuncName=void 0,this.endFunc=void 0,this.endFuncObj=void 0,this.endFuncName=void 0,this.startedPause=!1,this.startedPauseRecovery=!1,this.startedAnimation=!1,this.frameLimit=void 0}function SpriteAnimatedAtlas(a){SpriteAnimated.call(this,a)}function Text2D(){Renderable.call(this),this.font=void 0,this.lineHeight=0,this.text=[]}function Transformation(){this.position=new Vector2D,this.scale=new Vector2D(1,1),this.angle=0,this.rotationPivot=new Vector2D}function Vector2D(a,b){this.x=a||0,this.y=b||0}Layer.prototype={Add:function(a){this.renderables.push(a)},Remove:function(a){for(var b=0;b<this.renderables.length;b++)if(this.renderables[b]==a&&this.renderables[b]==a){this.renderables.splice(b,1);break}},SetOpacity:function(a){this.opacity=a},GetOpacity:function(){return this.opacity},Visible:function(a){this.visible=a}},PreloadImages.prototype={OnUpdate:function(a,b){return b?(this.funcUpdateObj=a,this.funcUpdateName=b):this.funcUpdate=func,this},OnComplete:function(a,b){return b?(this.funcCompleteObj=a,this.funcCompleteName=b):this.funcComplete=a,this},NumberOfImagesToLoad:function(){return this.counter},NumberOfLoadedImages:function(){return this.counterLoaded},_PreLoadImage:function(a){var b=new Image;b.src=a;var c=this;b.onload=function(d){c._LoadedImage(b,a)}},_LoadedImage:function(a,b){this.assets[b]=a,this.counterLoaded++,this.couner!=this.counterLoaded&&(void 0!==this.funcUpdate?this.funcUpdate():void 0!==this.funcUpdateObj&&this.funcUpdateObj[this.funcUpdateName]()),this.counter==this.counterLoaded&&(void 0!==this.funcComplete?this.funcComplete():void 0!==this.funcCompleteObj&&this.funcCompleteObj[this.funcCompleteName]())},Load:function(a){return this._PreLoadImage(a,this.counter++),this},GetImage:function(a){return this.assets[a]}},Renderable.prototype={SetShape:function(a){this.shape=a},SetVisible:function(a){this.visible=a},IsVisible:function(){return this.visible},SetOnCamera:function(a){this.OnCamera=a},IsOnCamera:function(){return this.OnCamera},SetOpacity:function(a){this.opacity=a},GetOpacity:function(){return this.opacity},SetClickable:function(a){this.isClickable=a},GetWidth:function(){return this.width},GetHeight:function(){return this.height},Draw:function(a){},_Draw:function(a){a.save(),a.translate(this.transformation.position.x,this.transformation.position.y),a.rotate(this.transformation.angle),a.translate(this.transformation.rotationPivot.x,this.transformation.rotationPivot.y),this.Draw(a),a.restore()},_OnClick:function(a,b){},_OnMouseMove:function(a,b){},_OnUpdate:function(){this.updateFunc&&this.updateFunc(),this.updateFuncObj&&this.updateFuncObj[this.updateFuncName]()},_update:function(a){this.Update(a),void 0!=this.updateFunc&&this.updateFunc(),void 0!=this.updateFuncObj&&this.updateFuncObj[this.updateFuncName]()},Update:function(a){},OnClick:function(){},OnMouseOver:function(){},OnMouseOut:function(){},OnUpdate:function(a,b){void 0===b?this.updateFunc=a:(this.updateFuncObj=a,this.updateFuncName=b)}};var RenderableShape={Circle:1,Quad:2};Scene.prototype={constructor:Scene,Update:function(){var a=(new Date).getTime();this.time;if(this.time=a,this.currentTime=(this.time-this.initTime)/1e3,1!=this.camera.transformation.scale.x||1!=this.camera.transformation.scale.y)var b=.5*(this.GetWidth()-this.GetWidth()/this.camera.transformation.scale.x),c=.5*(this.GetHeight()-this.GetHeight()/this.camera.transformation.scale.y),d=b+this.mouse.x*(this.GetWidth()-2*b)/this.GetWidth(),e=c+this.mouse.y*(this.GetHeight()-2*c)/this.GetHeight();for(var f=0;f<this.layers.length;f++)if(this.layers[f].visible)for(var g=0;g<this.layers[f].renderables.length;g++)this.layers[f].renderables[g]._update(this.currentTime),this.usingMouse&&void 0!=this.layers[f].renderables[g]&&this.layers[f].renderables[g].IsVisible()&&this.layers[f].renderables[g].isClickable&&(this.layers[f].renderables[g].IsOnCamera()?1!=this.camera.transformation.scale.x||1!=this.camera.transformation.scale.y?this.layers[f].renderables[g]._OnMouseMove(d-this.camera.transformation.position.x,e-this.camera.transformation.position.y):this.layers[f].renderables[g]._OnMouseMove(this.mouse.x-this.camera.transformation.position.x,this.mouse.y-this.camera.transformation.position.y):this.layers[f].renderables[g]._OnMouseMove(this.mouse.x,this.mouse.y))},SetGlobalOpacity:function(a){this.opacity=a},GetLayer:function(a){return void 0===a&&(a=0),this.layers[a]},Resize:function(a,b){this.element.width=a,this.element.height=b},Draw:function(){},Add:function(a,b){if(void 0===b&&(b=0),this.layers.length<b+1)for(var c=0;c<=b;c++)void 0===this.layers[c]&&(this.layers[c]=new Layer);this.layers[b].Add(a)},Remove:function(a,b){void 0===b&&(b=0),this.layers[b].Remove(a),0==this.layers[b].renderables.length&&this.layers.splice(b,1)},GetWidth:function(){return this.element.width},GetHeight:function(){return this.element.height},GetTime:function(){return this.currentTime},DisableMouse:function(){this.usingMouse=!1},EnableCulling:function(){this.isCulling=!0},DisableCulling:function(){this.isCulling=!1},EnableMouse:function(){this.usingMouse=!0},_Culling:function(a){if(!this.isCulling)return!0;var b=this.camera.transformation.position;a.IsOnCamera()||(b={x:0,y:0});var c=a.transformation.position.x-.5*a.GetWidth()*a.transformation.scale.x,d=a.transformation.position.x+.5*a.GetWidth()*a.transformation.scale.x,e=a.transformation.position.y-.5*a.GetHeight()*a.transformation.scale.y,f=a.transformation.position.y+.5*a.GetWidth()*a.transformation.scale.y;return c<-b.x+this.GetWidth()&&-b.x<d&&e<-b.y+this.GetHeight()&&f>-b.y},_OnClick:function(){if(this.usingMouse)for(var a=this.layers.length-1;a>=0;a--)if(this.layers[a].visible)for(var b=this.layers[a].renderables.length-1;b>=0;b--)if(this.layers[a].renderables[b].IsVisible()&&this.layers[a].renderables[b].isClickable)if(this.layers[a].renderables[b].IsOnCamera()){if(this.layers[a].renderables[b]._OnClick(this.mouse.x-this.camera.transformation.position.x,this.mouse.y+this.camera.transformation.position.y))return!0}else if(this.layers[a].renderables[b]._OnClick(this.mouse.x,this.mouse.y))return!0;return!1},_OnMouseMove:function(a,b){if(this.usingMouse){if(1!=this.camera.transformation.scale.x||1!=this.camera.transformation.scale.y)var c=.5*(this.GetWidth()-this.GetWidth()/this.camera.transformation.scale.x),d=.5*(this.GetHeight()-this.GetHeight()/this.camera.transformation.scale.y),e=c+a*(this.GetWidth()-2*c)/this.GetWidth(),f=d+b*(this.GetHeight()-2*d)/this.GetHeight();for(var g=this.layers.length-1;g>=0;g--)if(this.layers[g].visible)for(var h=this.layers[g].renderables.length-1;h>=0;h--)this.layers[g].renderables[h].IsVisible()&&this.layers[g].renderables[h].isClickable&&(this.layers[g].renderables[h].IsOnCamera()?1!=this.camera.transformation.scale.x||1!=this.camera.transformation.scale.y?this.layers[g].renderables[h]._OnMouseMove(e-this.camera.transformation.position.x,f-this.camera.transformation.position.y):this.layers[g].renderables[h]._OnMouseMove(a-this.camera.transformation.position.x,b-this.camera.transformation.position.y):this.layers[g].renderables[h]._OnMouseMove(a,b))}},_MouseClick:function(){this._OnClick()},_MouseMove:function(a){var b=a.clientX,c=a.clientY;b-=this.element.offsetLeft,c-=this.element.offsetTop,this.mouse.x=b,this.mouse.y=c,this._OnMouseMove(this.mouse.x,this.mouse.y)}},SceneCanvas.prototype=Object.create(Scene.prototype),SceneCanvas.prototype.constructor=SceneCanvas,SceneCanvas.prototype.CreateEventListeners=function(){this.element.addEventListener("mousedown",this,!1),this.element.addEventListener("mousemove",this,!1),this.handleEvent=function(a){switch(a.type){case"mousemove":this._MouseMove(a);break;case"mousedown":this._MouseClick(a)}}},SceneCanvas.prototype.Draw=function(){var a=this.context;a.clearRect(0,0,this.element.width,this.element.height);for(var b=0;b<this.layers.length;b++){this.opacityState=this.opacity,a.globalAlpha=this.opacity,this.sceneOpacityChanged=1!=this.opacity,a.save(),this.layers[b].hasTransformations&&(a.save(),a.translate(this.layers[b].transformation.position.x,this.layers[b].transformation.position.y),a.rotate(this.layers[b].transformation.angle),a.scale(this.layers[b].transformation.scale.x,this.layers[b].transformation.scale.y));for(var c=0;c<this.layers[b].renderables.length;c++)!this.layers[b].renderables[c].IsOnCamera()&&this.layers[b].visible&&this.layers[b].renderables[c].IsVisible()&&this._Culling(this.layers[b].renderables[c])&&(1!=this.layers[b].GetOpacity()&&(this.opacityState=this.layers[b].GetOpacity(),a.globalAlpha=this.layers[b].GetOpacity(),this.layerOpacityChanged=!0),this.sceneOpacityChanged||void 0===this.layers[b].renderables[c].GetOpacity()||(this.opacityState=this.layers[b].renderables[c].GetOpacity(),a.globalAlpha=this.layers[b].renderables[c].GetOpacity()),this.layers[b].renderables[c]._Draw(a),this.opacity!=this.opacityState&&(this.opacityState=this.opacity,a.globalAlpha=this.opacity,this.sceneOpacityChanged=1!=this.opacity));a.save(),1==this.camera.transformation.scale.x&&1==this.camera.transformation.scale.y||(a.translate(-this.GetWidth()*(.5*this.camera.transformation.scale.x-.5),-this.GetHeight()*(.5*this.camera.transformation.scale.y-.5)),a.scale(this.camera.transformation.scale.x,this.camera.transformation.scale.y)),a.translate(this.camera.transformation.position.x,this.camera.transformation.position.y),a.rotate(-this.camera.transformation.angle),a.translate(this.camera.transformation.rotationPivot.x,this.camera.transformation.rotationPivot.y);for(var c=0;c<this.layers[b].renderables.length;c++)this.layers[b].renderables[c].IsOnCamera()&&this.layers[b].visible&&(1!=this.layers[b].GetOpacity()&&(this.opacityState=this.layers[b].GetOpacity(),a.globalAlpha=this.layers[b].GetOpacity(),this.layerOpacityChanged=!0),this.layers[b].renderables[c].IsVisible()&&this._Culling(this.layers[b].renderables[c])&&(this.sceneOpacityChanged||void 0===this.layers[b].renderables[c].GetOpacity()||(this.opacityState=this.layers[b].renderables[c].GetOpacity(),a.globalAlpha=this.layers[b].renderables[c].GetOpacity()),this.layers[b].renderables[c]._Draw(a),this.opacity!=this.opacityState&&(this.opacityState=this.opacity,a.globalAlpha=this.opacity,this.sceneOpacityChanged=1!=this.opacity)));a.restore(),this.layers[b].hasTransformations&&a.restore()}a.restore()},Sprite.prototype=Object.create(Renderable.prototype),Sprite.prototype.constructor=Sprite,Sprite.prototype.LoadTexture=function(a){this.textures.push(a)},Sprite.prototype.SetClipping=function(a,b,c,d){this.clippingX=a,this.clippingY=b,this.clippingWidth=c,this.clippingHeight=d,this.isClipping=!0},Sprite.prototype.DisableClipping=function(){this.isClipping=!1},Sprite.prototype.GetWidth=function(){return 0==this.textures.length?0:this.isClipping?this.clippingWidth:this.textures[this.textureInUse].width},Sprite.prototype.GetHeight=function(){return 0==this.textures.length?0:this.isClipping?this.clippingHeight:this.textures[this.textureInUse].height},Sprite.prototype.Draw=function(a){this.textures.length>0&&a.drawImage(this.textures[this.textureInUse],this.isClipping?this.clippingX:0,this.isClipping?this.clippingY:0,this.isClipping?this.clippingWidth:this.textures[this.textureInUse].width,this.isClipping?this.clippingHeight:this.textures[this.textureInUse].height,.5*-this.transformation.scale.x*(this.isClipping?this.clippingWidth:this.textures[this.textureInUse].width),.5*-this.transformation.scale.y*(this.isClipping?this.clippingHeight:this.textures[this.textureInUse].height),this.isClipping?this.clippingWidth*this.transformation.scale.x:this.transformation.scale.x*this.textures[this.textureInUse].width,this.isClipping?this.clippingHeight*this.transformation.scale.y:this.transformation.scale.y*this.textures[this.textureInUse].height)},Sprite.prototype._OnClick=function(a,b){return this.mouseover&&this.OnClick(),this.mouseover},Sprite.prototype._OnMouseMove=function(a,b){switch(this.shape){case RenderableShape.Circle:var c=this.transformation.position.x-a,d=this.transformation.position.y-b,e=this.GetWidth()*this.transformation.scale.x*.5;c*c+d*d<e*e?(this.mouseover=!0,this.OnMouseOver()):(this.mouseover&&this.OnMouseOut(),this.mouseover=!1);break;case RenderableShape.Quad:Math.abs(a-this.transformation.position.x)<.5*this.transformation.scale.x*this.GetWidth()&&Math.abs(b-this.transformation.position.y)<.5*this.transformation.scale.y*this.GetHeight()?(this.mouseover=!0,this.OnMouseOver()):(this.mouseover&&this.OnMouseOut(),this.mouseover=!1)}},SpriteAnimated.prototype=Object.create(Sprite.prototype),SpriteAnimated.prototype.constructor=SpriteAnimated,SpriteAnimated.prototype.OnStart=function(a,b){void 0===b?this.startFunc=a:(this.startFuncObj=a,this.startFuncName=b)},SpriteAnimated.prototype.OnComplete=function(a,b){void 0===b?this.endFunc=a:(this.endFuncObj=a,this.endFuncName=b)},SpriteAnimated.prototype._OnStart=function(){this.startFunc&&this.startFunc(),this.startFuncObj&&this.startFuncObj[this.startFuncName]()},SpriteAnimated.prototype._OnComplete=function(){this.endFunc&&this.endFunc(),this.endFuncObj&&this.endFuncObj[this.endFuncName]()},SpriteAnimated.prototype.IsPlaying=function(){return this.isPlaying},SpriteAnimated.prototype.GetNumberOfFrames=function(){return(this.frameLimit?this.frameLimit:this.textures.length)-(this.frameInit?this.frameInit:0)},SpriteAnimated.prototype.SetInitialFrame=function(a){this.frameInit=a},SpriteAnimated.prototype.SetFinalFrame=function(a){this.frameLimit=a},SpriteAnimated.prototype._update=function(a){if(this.startedAnimation&&(this.startedAnimation=!1,this.timeStart=a),this.startedPause&&(this.isPaused=!0,this.startedPause=!1,this.timerPauseStart=a),this.startedPauseRecovery&&(this.startedPauseRecovery=!1,this.timerPauseEnd=a,this.isPaused=!1,this.timerPauseLength+=this.timerPauseEnd-this.timerPauseStart),this.isPlaying&&!this.isPaused){var b=1/this.frameSpeed,c=a-(this.timeStart+this.timerPauseLength),d=this.GetNumberOfFrames()*(this.yoyo?2:1),e=Math.abs(Math.ceil(c/b)-1);e<d?this.yoyo&&e>=this.GetNumberOfFrames()?this._frame=this.GetNumberOfFrames()-(e-this.GetNumberOfFrames()+1):this._frame=e:this.isLooping?(this.timeStart=a,this.timerPauseLength=0,this._frame=0):this.repeat>0&&this._internalRepeat<this.repeat?(this.timeStart=a,this.timerPauseLength=0,this._frame=0,this._internalRepeat++):(this._internalRepeat=1,this.isPlaying=!1,this._frame=this.yoyo?0:d-1,this._OnComplete()),this._OnUpdate()}this.textureInUse=(this.reverse?this.GetNumberOfFrames()-this._frame-1:this._frame)+(this.frameInit?this.frameInit:0),this.Update(a)},SpriteAnimated.prototype.Play=function(a,b){this.repeat=void 0===a?0:a,this.reverse=void 0!==b,this.isLooping=this.repeat<=0,this.isPlaying=!0,this.OnStart(),this.startedAnimation=!0},SpriteAnimated.prototype.YoYo=function(a){this.yoyo=a},SpriteAnimated.prototype.Pause=function(){this.isPaused?this.startedPauseRecovery=!0:this.startedPause=!0},SpriteAnimated.prototype.Stop=function(){this.isPlaying=!1,this._frame=0},SpriteAnimatedAtlas.prototype=Object.create(SpriteAnimated.prototype),SpriteAnimatedAtlas.prototype.constructor=SpriteAnimatedAtlas,SpriteAnimatedAtlas.prototype.LoadTexture=function(a,b,c,d){SpriteAnimated.prototype.LoadTexture.call(this,a),this.numberOfFrames=d,this.framePerColumn=b,this.framePerLine=c,this.frameWidth=a.width/b,this.frameHeight=a.height/c},SpriteAnimatedAtlas.prototype.GetNumberOfFrames=function(){return(this.frameLimit?this.frameLimit:this.numberOfFrames)-(this.frameInit?this.frameInit:0)},SpriteAnimatedAtlas.prototype._update=function(a){SpriteAnimated.prototype._update.call(this,a);var b=this.textureInUse;this.textureInUse=0,this.SetClipping(b%this.framePerColumn*this.frameWidth,Math.floor(b/this.framePerColumn)*this.frameHeight,this.frameWidth,this.frameHeight)},Text2D.prototype=Object.create(Renderable.prototype),Text2D.prototype.constructor=Text2D,Text2D.prototype.SetFont=function(a){this.font=a},Text2D.prototype.SetColor=function(a){this.color=a},Text2D.prototype.SetText=function(a){this.text=a.split("\n");var b=document.createElement("canvas");b.width=1e4,b.height=1e4;var c=b.getContext("2d");c.font=this.font;var d=c.measureText(this.text[0]);this.width=this.height=d.width},Text2D.prototype.SetLineHeight=function(a){this.lineHeight=a},Text2D.prototype.Draw=function(a){a.translate(.5*-this.GetWidth(),0),a.font=this.font,a.fillStyle=this.color;for(var b=0;b<this.text.length;b++)a.fillText(this.text[b],0,b*this.lineHeight)},Transformation.prototype={SetRotation:function(a){this.angle=a||0},ClearTransforms:function(){this.transformation.position=new Vector2D,this.transformation.scale=new Vector2D,this.angle=0,this.rotationPivot=new Vector2D}},Vector2D.prototype={SetX:function(a){this.x=a||0},SetY:function(a){this.y=a||0},GetX:function(){return this.x},GetY:function(){return this.y},MagnitudeSQR:function(){return this.x*this.x+this.y*this.y},Magnitude:function(){return Math.sqrt(this.MagnitudeSQR())},Add:function(a){return a instanceof Vector2D?new Vector2D(this.x+a.x,this.y+a.y):new Vector2D(this.x+a,this.y+a)},Sub:function(a){return a instanceof Vector2D?new Vector2D(this.x-a.x,this.y-a.y):new Vector2D(this.x-a,this.y-a)},Mul:function(a){return a instanceof Vector2D?new Vector2D(this.x*a.x,this.y*a.y):new Vector2D(this.x*a,this.y*a)},Div:function(a){return a instanceof Vector2D?new Vector2D(this.x/a.x,this.y/a.y):new Vector2D(this.x/a,this.y/a)},DistanceSQR:function(a){return this.Sub(a).MagnitudeSQR()},Distance:function(a){return this.Sub(a).Magnitude()},Negate:function(){this.x=-this.x,this.y=-this.y},Abs:function(){return new Vector2D(Math.abs(this.x),Math.abs(this.y))},Normalize:function(){var a=this.Magnitude();return 0==a&&(a=1),new Vector2D(this.x/a,this.y/a)}};